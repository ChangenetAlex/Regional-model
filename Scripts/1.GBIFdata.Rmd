---
title: "RGBIF request"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library("rgbif")
library(ggmap)
library(cowplot)
library(data.table)
library(dplyr)
library(CoordinateCleaner)
library(sf)
```


Here we need a chunk that go and download the city spatial polygon + central point 
```{r}

```


Manual Polygon of the cities 
```{r}
Munich <- "POLYGON((11.359 48.165,11.364 48.169,11.366 48.18,11.373 48.183,11.385 48.182,11.386 48.184,11.388 48.184,11.385 48.188,11.385 48.195,11.388 48.204,11.455 48.212,11.457 48.216,11.463 48.22,11.47 48.223,11.484 48.225,11.484 48.234,11.486 48.236,11.488 48.249,11.498 48.252,11.505 48.252,11.525 48.246,11.529 48.244,11.533 48.235,11.546 48.233,11.548 48.231,11.569 48.231,11.583 48.233,11.591 48.226,11.591 48.218,11.594 48.217,11.598 48.217,11.6 48.221,11.604 48.222,11.602 48.224,11.602 48.229,11.605 48.232,11.612 48.231,11.626 48.233,11.642 48.229,11.644 48.224,11.654 48.219,11.655 48.214,11.653 48.209,11.649 48.205,11.643 48.203,11.641 48.194,11.635 48.186,11.636 48.183,11.635 48.181,11.64 48.18,11.641 48.178,11.647 48.178,11.657 48.18,11.658 48.185,11.661 48.187,11.682 48.185,11.692 48.187,11.699 48.182,11.7 48.172,11.695 48.167,11.69 48.167,11.681 48.158,11.684 48.154,11.683 48.149,11.712 48.152,11.717 48.148,11.717 48.142,11.722 48.143,11.726 48.14,11.727 48.136,11.723 48.131,11.72 48.13,11.719 48.124,11.713 48.119,11.715 48.115,11.719 48.112,11.716 48.102,11.71 48.098,11.694 48.093,11.69 48.088,11.686 48.088,11.686 48.084,11.688 48.082,11.687 48.081,11.69 48.078,11.688 48.074,11.675 48.075,11.664 48.074,11.638 48.08,11.632 48.08,11.628 48.083,11.618 48.085,11.613 48.083,11.607 48.083,11.605 48.081,11.602 48.081,11.6 48.083,11.596 48.081,11.591 48.081,11.588 48.087,11.585 48.089,11.566 48.082,11.565 48.08,11.562 48.08,11.562 48.078,11.558 48.075,11.554 48.076,11.554 48.073,11.546 48.064,11.541 48.065,11.54 48.071,11.538 48.074,11.535 48.074,11.53 48.065,11.523 48.062,11.52 48.063,11.516 48.059,11.513 48.06,11.511 48.058,11.503 48.058,11.499 48.064,11.499 48.067,11.492 48.07,11.485 48.07,11.482 48.072,11.482 48.074,11.476 48.077,11.472 48.077,11.468 48.08,11.467 48.085,11.469 48.087,11.468 48.091,11.47 48.095,11.467 48.097,11.467 48.101,11.462 48.101,11.459 48.104,11.459 48.115,11.462 48.118,11.46 48.127,11.455 48.129,11.447 48.127,11.444 48.13,11.439 48.13,11.434 48.133,11.428 48.133,11.425 48.129,11.413 48.123,11.404 48.121,11.392 48.122,11.391 48.124,11.388 48.124,11.385 48.128,11.384 48.136,11.387 48.138,11.386 48.144,11.381 48.146,11.379 48.149,11.371 48.15,11.37 48.153,11.368 48.153,11.367 48.155,11.359 48.154,11.357 48.156,11.358 48.161,11.359 48.165))"

Wien <- "POLYGON((16.16 48.175,16.185 48.2,16.165 48.215,16.165 48.23,16.175 48.24,16.18 48.265,16.2 48.285,16.215 48.285,16.25 48.265,16.27 48.275,16.28 48.29,16.315 48.295,16.335 48.31,16.36 48.31,16.36 48.325,16.38 48.34,16.425 48.345,16.455 48.33,16.46 48.305,16.475 48.315,16.515 48.31,16.535 48.295,16.535 48.285,16.565 48.275,16.565 48.255,16.575 48.24,16.56 48.195,16.595 48.17,16.595 48.125,16.57 48.115,16.53 48.125,16.51 48.14,16.48 48.135,16.475 48.125,16.455 48.12,16.445 48.1,16.4 48.1,16.345 48.115,16.335 48.115,16.32 48.1,16.3 48.1,16.275 48.115,16.21 48.105,16.195 48.115,16.195 48.135,16.165 48.16,16.16 48.175))" 

Genoa <- "MULTIPOLYGON(((8.84230609125465 44.422,8.8423245 44.4220407,8.8415446 44.4222216,8.84145381057511 44.422,8.839 44.422,8.84 44.423,8.837 44.425,8.824 44.424,8.816 44.426,8.806 44.424,8.788 44.426,8.787 44.428,8.785 44.426,8.776 44.428,8.776 44.425,8.779 44.424,8.797 44.421,8.796 44.418,8.776 44.421,8.775 44.424,8.766 44.425,8.759 44.428,8.741 44.428,8.736 44.423,8.729 44.422,8.726 44.418,8.706 44.415,8.706 44.417,8.709 44.419,8.709 44.423,8.707 44.425,8.698 44.426,8.699 44.433,8.696 44.439,8.686 44.44,8.682 44.438,8.674 44.444,8.673 44.448,8.669 44.451,8.672 44.456,8.672 44.459,8.669 44.46,8.67 44.462,8.667 44.465,8.67 44.467,8.67 44.475,8.676 44.481,8.685 44.481,8.686 44.483,8.693 44.483,8.697 44.48,8.708 44.479,8.712 44.473,8.718 44.471,8.719 44.472,8.718 44.467,8.721 44.465,8.721 44.46,8.729 44.46,8.735 44.457,8.734 44.455,8.74 44.449,8.74 44.443,8.744 44.443,8.745 44.441,8.752 44.442,8.753 44.446,8.751 44.45,8.76 44.453,8.764 44.452,8.766 44.455,8.768 44.455,8.774 44.468,8.778 44.472,8.784 44.474,8.785 44.476,8.785 44.478,8.78 44.481,8.772 44.482,8.772 44.488,8.789 44.487,8.787 44.495,8.79 44.496,8.802 44.493,8.803 44.491,8.805 44.491,8.805 44.489,8.811 44.489,8.812 44.493,8.818 44.498,8.822 44.498,8.831 44.49,8.836 44.49,8.839 44.487,8.847 44.489,8.849 44.491,8.854 44.49,8.855 44.48,8.852 44.481,8.847 44.479,8.85 44.473,8.858 44.472,8.859 44.475,8.865 44.477,8.868 44.475,8.876 44.475,8.883 44.472,8.89 44.472,8.892 44.474,8.892 44.476,8.889 44.476,8.89 44.487,8.886 44.494,8.887 44.496,8.893 44.497,8.894 44.501,8.898 44.502,8.897 44.509,8.895 44.51,8.896 44.515,8.894 44.517,8.9 44.518,8.903 44.514,8.907 44.514,8.912 44.511,8.912 44.508,8.91 44.508,8.91 44.506,8.907 44.505,8.906 44.5,8.904 44.5,8.904 44.497,8.908 44.495,8.904 44.493,8.905 44.484,8.921 44.484,8.919 44.48,8.916 44.478,8.916 44.475,8.923 44.476,8.927 44.471,8.933 44.469,8.928 44.465,8.928 44.462,8.93 44.462,8.933 44.459,8.936 44.459,8.935 44.456,8.939 44.452,8.951 44.454,8.954 44.451,8.96 44.45,8.961 44.454,8.959 44.455,8.961 44.456,8.961 44.461,8.959 44.463,8.96 44.464,8.959 44.466,8.963 44.471,8.985 44.475,8.987 44.478,8.99 44.478,8.996 44.482,9 44.482,9.002 44.484,9.004 44.483,9.004 44.476,9.008 44.471,9.016 44.473,9.018 44.476,9.023 44.475,9.025 44.477,9.028 44.477,9.033 44.483,9.039 44.482,9.041 44.479,9.054 44.482,9.055 44.48,9.053 44.48,9.05 44.476,9.05 44.47,9.048 44.47,9.043 44.466,9.043 44.464,9.041 44.464,9.041 44.462,9.039 44.462,9.039 44.457,9.036 44.456,9.035 44.452,9.034 44.453,9.032 44.452,9.032 44.45,9.036 44.448,9.037 44.449,9.037 44.446,9.04 44.445,9.042 44.441,9.047 44.44,9.048 44.438,9.05 44.439,9.052 44.433,9.055 44.43,9.057 44.43,9.059 44.424,9.062 44.423,9.062 44.42,9.072 44.416,9.073 44.414,9.084 44.413,9.088 44.411,9.086 44.41,9.085 44.407,9.083 44.407,9.081 44.403,9.076 44.402,9.076 44.397,9.071 44.397,9.067 44.394,9.067 44.392,9.065 44.392,9.066 44.389,9.063 44.388,9.063 44.383,9.058 44.383,9.057 44.381,9.053 44.38,9.035 44.382,9.034 44.384,9.027 44.383,9.019 44.384,9.018 44.386,9.016 44.385,9.008 44.387,9.006 44.386,9.001 44.388,8.998 44.387,8.995 44.39,8.987 44.393,8.982 44.393,8.979 44.391,8.967 44.391,8.963 44.393,8.951 44.392,8.95 44.395,8.94327761798409 44.395,8.9434587 44.3953434,8.94334 44.3953589,8.942857 44.3954874,8.94261145135225 44.395,8.941 44.395,8.937 44.398,8.933 44.396,8.933 44.401,8.929 44.402,8.93 44.404,8.925 44.407,8.927 44.407,8.929 44.41,8.928 44.413,8.925 44.415,8.915 44.415,8.915 44.413,8.912 44.414,8.909 44.411,8.909 44.406,8.917 44.403,8.916 44.4,8.911 44.4,8.909 44.401,8.909 44.404,8.905 44.404,8.902 44.402,8.901 44.405,8.898 44.404,8.897 44.407,8.882 44.409,8.882 44.406,8.88 44.406,8.877 44.407,8.877 44.41,8.874 44.41,8.871 44.406,8.823 44.416,8.843 44.414,8.845 44.416,8.853 44.418,8.853 44.42,8.847 44.422,8.84230609125465 44.422)),((8.706 44.415,8.706 44.414,8.705 44.414,8.705 44.415,8.706 44.415)),((8.925 44.407,8.924 44.407,8.925 44.408,8.925 44.407)),((8.923 44.408,8.921 44.407,8.922 44.408,8.923 44.408)))"

TA <- "POLYGON((34.735 32.033,34.737 32.039,34.737 32.05,34.745 32.06,34.751 32.064,34.762 32.096,34.767 32.105,34.768 32.112,34.772 32.116,34.784 32.149,34.786 32.151,34.804 32.148,34.806 32.146,34.806 32.14,34.802 32.135,34.806 32.135,34.811 32.132,34.814 32.128,34.816 32.128,34.816 32.133,34.819 32.135,34.83 32.134,34.84 32.131,34.848 32.123,34.852 32.124,34.856 32.122,34.855 32.112,34.853 32.105,34.851 32.103,34.844 32.104,34.837 32.101,34.828 32.102,34.826 32.096,34.823 32.093,34.813 32.092,34.813 32.089,34.809 32.086,34.804 32.087,34.803 32.084,34.806 32.079,34.805 32.073,34.807 32.07,34.806 32.07,34.81 32.064,34.815 32.062,34.816 32.059,34.815 32.056,34.818 32.052,34.818 32.043,34.814 32.037,34.812 32.037,34.81 32.031,34.802 32.032,34.796 32.036,34.79 32.037,34.786 32.041,34.776 32.029,34.763 32.033,34.763 32.03,34.749 32.025,34.738 32.03,34.735 32.033))"

Cities_Polygon <- list("Genoa"=Genoa,
                       "Munich"=Munich,
                       "Wien"=Wien,
                       "TelAviv"=TA)

Animal <- 1
Plante <- 6
```


Manual coordinates for requesting the data for the 4 cities and the 50km (at least) around
First we give as an input the centroid of the city. We define the buffer size we want to request. 
```{r}
cG <- c(44.40726,8.9338624)[c(2,1)]
cM <- c(48.1371079,11.5753822)[c(2,1)]
cW <- c(48.2083537,16.3725042)[c(2,1)]
cTA <- c(32.0852997,34.7818064)[c(2,1)]

dfcenter <- list("Genova"=cG,"Munich"=cM,"Wien"=cW,"TelAviv"=cTA)
Buffer <- 55000

My_Pol<- lapply(dfcenter,function(x){
  City_center <- st_sfc(st_point(x), crs = "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 ")
  circle <- st_buffer(City_center, Buffer) 
  My_Polygon <- st_as_text(circle)
;My_Polygon})
```

Function to request 4 dataset for the gievn buffers.
```{r}
gbif_taxon_keys <- c(1,6)
user="achangenet" # GBIF user name
pwd="0503Alex!" # GBIF password
email="alex.changenet@live.fr" # your email
My_Pol[4]
lapply(My_Pol[[4]],function(x){
gbif_download = occ_download(
type="and",
pred_in("taxonKey", gbif_taxon_keys),
pred("hasGeospatialIssue", FALSE),
pred("hasCoordinate", TRUE),
pred_gte("year", 1980),
pred_not(pred("basisOfRecord", "FOSSIL_SPECIMEN")),
pred_within(x),
format = "SIMPLE_CSV",
user=user,pwd=pwd,email=email
)
})
```


Request to download though the API. For given Polygon of the 4 cities
```{r}
lapply(Cities_Polygon,function(x){
gbif_download = occ_download(
type="and",
pred_in("taxonKey", gbif_taxon_keys),
pred("hasGeospatialIssue", FALSE),
pred("hasCoordinate", TRUE),
pred_gte("year", 1980),
pred_not(pred("basisOfRecord", "FOSSIL_SPECIMEN")),
pred_within(x),
format = "SIMPLE_CSV",
user=user,pwd=pwd,email=email
)
})
```

Check where are my dl
```{r}
Dw <- occ_download_list(
user=user,pwd=pwd,
limit = 20,
start = 0,
curlopts = list()
)
```

Cancel if needed
```{r}
occ_download_cancel(user=user,pwd=pwd,
key="0110893-210914110416597")
```






