---
title: "RGBIF data processing"
author: "A.Changenet"
date: "10-03-2022->`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
    fig_width: 12
    fig_height: 8
    fig_caption: no
  rmdformats::downcute:
    
    self_contained: true
    code_folding: show
    toc_depth: 2
    number_sections: true
    fig_width: 12
    fig_height: 8
    collapsed: true
    df_print: paged
  word_document:
    toc_depth: 2
    number_sections: yes
    fig_width: 12
    fig_height: 8
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
```


```{r}
library("rgbif")
library(ggmap)
library(cowplot)
library(data.table)
library(dplyr)
library(CoordinateCleaner)
library(sf)
library(sp)
library(rgeos)
library(maptools)
library(proj4)
library(rgdal)
library(dplyr)
library(raster)
```


Load the data of the 4 cities and set the 4 city center. (longitude first then latitude)
```{r}
dfM <- fread("~/Library/CloudStorage/OneDrive-u-bordeaux.fr/Postdoc_Italy/data/GBIF/0114847-210914110416597.csv", header = T, sep = "\t", dec = ".", quote = "", data.table = T)

dfTA <- fread("~/Library/CloudStorage/OneDrive-u-bordeaux.fr/Postdoc_Italy/data/GBIF/0114848-210914110416597.csv", header = T, sep = "\t", dec = ".", quote = "", data.table = T)

dfG <- fread("~/Library/CloudStorage/OneDrive-u-bordeaux.fr/Postdoc_Italy/data/GBIF/0114849-210914110416597.csv", header = T, sep = "\t", dec = ".", quote = "", data.table = T)

dfW <- fread("~/Library/CloudStorage/OneDrive-u-bordeaux.fr/Postdoc_Italy/data/GBIF/0150587-210914110416597.csv", header = T, sep = "\t", dec = ".", quote = "", data.table = T)

cG <- c(44.40726,8.9338624)[c(2,1)]
cM <- c(48.1371079,11.5753822)[c(2,1)]
cW <- c(48.2083537,16.3725042)[c(2,1)]
cTA <- c(32.0852997,34.7818064)[c(2,1)]

dfcenter <- list("cG"=cG,"cM"=cM,"cW"=cW,"cTA"=cTA)
dfcity <- list("dfG"=dfG,"dfM"=dfM,"dfW"=dfW,"dfTA"=dfTA)
```

Now load the buffer of 50km
```{r}
dfG <- fread("~/Library/CloudStorage/OneDrive-u-bordeaux.fr/Postdoc_Italy/data/GBIF/Buffer/0150360-210914110416597.csv", header = T, sep = "\t", dec = ".", quote = "", data.table = T)

dfM <- fread("~/Library/CloudStorage/OneDrive-u-bordeaux.fr/Postdoc_Italy/data/GBIF/Buffer/0150361-210914110416597.csv", header = T, sep = "\t", dec = ".", quote = "", data.table = T)

dfW <- fread("~/Library/CloudStorage/OneDrive-u-bordeaux.fr/Postdoc_Italy/data/GBIF/Buffer/0150362-210914110416597.csv", header = T, sep = "\t", dec = ".", quote = "", data.table = T)

dfTA <- fread("~/Library/CloudStorage/OneDrive-u-bordeaux.fr/Postdoc_Italy/data/GBIF/Buffer/0150384-210914110416597.csv", header = T, sep = "\t", dec = ".", quote = "", data.table = T)

cG <- c(44.40726,8.9338624)[c(2,1)]
cM <- c(48.1371079,11.5753822)[c(2,1)]
cW <- c(48.2083537,16.3725042)[c(2,1)]
cTA <- c(32.0852997,34.7818064)[c(2,1)]

dfcenter <- list("cG"=cG,"cM"=cM,"cW"=cW,"cTA"=cTA)
dfcity <- list("dfG"=dfG,"dfM"=dfM,"dfW"=dfW,"dfTA"=dfTA)
```

In this chunk we define the taxa we want to investigate and the city to be extracted (in a vector for urban area) and in a list to extract according to a buffer. 
```{r}
lspecies <- c(
  "Total",
  "Animalia",
  "Plantae",
  "Mammalia",
  "Aves",
  "Insecta",
  "Amphibia",
  "Reptilia",
  "Arachnida"
)
names(lspecies) <- lspecies 
cSp.Curve <- c("Genova","Munich","Wien","TelAViv")
lSp.Curve <- list("Genova"=NULL,"Munich"=NULL,"Wien"=NULL,"TelAViv"=NULL)
```

Now we define the buffers we want to loop over. Be careful. Too many values at once causes problem with the parallel package. So better to use only one core in the case of a lot of buffer. 
```{r}
Buffer <- as.list(c(1000,2000)) # for testng purpose
Buffer <- as.list(c(1000,2000,3000,seq(5000,50000,5000)))
```

Here is a function to extract the number of occurrence within the city boundaries and save it as a data.frame. 
```{r}
setwd("~/Library/CloudStorage/OneDrive-u-bordeaux.fr/Postdoc_Italy/Script/Regional_model")
Sp.Curve <- mapply(function(x,y){
  df <- x
    Tot_A <- lapply(lspecies, function(s){
      Tot_A <- subset(df,select=c("species","kingdom","class"))
        if (s%in%c("Total")){
          Tot_A <- subset(Tot_A,select="species")
        } else if (s%in%c("Animalia","Plantae")){
          Tot_A <- subset(Tot_A,kingdom == s,select="species")
        } else {
          Tot_A <- subset(Tot_A,class == s,select="species")
        }
      Tot_obs <- Tot_A %>% nrow %>% as.numeric
      Tot_A <- Tot_A %>% unique %>% nrow %>% as.numeric
      Obs.sp <- Tot_A/Tot_obs
      Species_accum <- c("sp"=as.numeric(Tot_A),
                         "obs"=as.numeric(Tot_obs),
                         "sp.obs"=as.numeric(Obs.sp),
                         "Taxa"=s)
        ;Species_accum})
    Species_accum <- as.data.frame(do.call(rbind,Tot_A))
    Species_accum$Distance <- NA
    Species_accum$city <- y
    ;Species_accum},x=dfcity,y=cSp.Curve, SIMPLIFY = FALSE)
dfSp.Curve <- as.data.frame(do.call(rbind,Sp.Curve))
dfSp.Curve$sp <- as.numeric(dfSp.Curve$sp)
saveRDS(dfSp.Curve,file = "Species_City_Data_Sp.obs.rds")
```



Here we repeat the same operation but we do that for every buffer we defined. 
We first need to convert data frame to sf using these as coordinates. 
This need to be changed. The parallellization need to occurs on the city (instead of the loop) and the loop instead of the parallel process. Or number of core needs to be reduce to 4 maybe. 
```{r}
setwd("~/Library/CloudStorage/OneDrive-u-bordeaux.fr/Postdoc_Italy/Script/Regional_model")
for (i in 1:length(dfcity)){
  df <- dfcity[[i]]
  Center <- dfcenter[[i]]
  SP_DF = st_as_sf(df,coords=c("decimalLongitude","decimalLatitude"),
                   crs = "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 ")
  City_center <- st_sfc(st_point(Center), crs = "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0 ")
  Sp.Curve <- parallel::mclapply(Buffer, function(x) {
    circle <- st_buffer(City_center, x) 
    SP_DF_col <- st_cast(SP_DF, "POINT")
    INTER_point <- st_intersects(circle, SP_DF_col)[[1]]
    SP_DF_col_intersect <- SP_DF_col[INTER_point,]
    Year <- sort(unique(SP_DF_col_intersect$year))
    Species_accum_year <- vector("list",length(Year))
    names(Species_accum_year) <- Year
    Tot_A <- lapply(lspecies, function(s){
      Species_accum_Taxa <- data.frame(Year,"sp"=NA,"obs"=NA,"sp.obs"=NA)
      Species_accum_LISTE <- data.frame(species=NULL)
      Species_accum_LISTE$species <- as.character(Species_accum_LISTE$species) 
      Species_accum_OBSTOT <- c(0)

      for (i in 1:length(Year)){
        SP_DF_col_intersect_YEAR <- subset(SP_DF_col_intersect,year == Year[i],
                                           select=c("species","kingdom","class"))
        Tot_A <- SP_DF_col_intersect_YEAR %>% 
          st_drop_geometry
        if (s%in%c("Total")){
          Tot_A <- subset(Tot_A,select="species")
        } else if (s%in%c("Animalia","Plantae")){
          Tot_A <- subset(Tot_A,kingdom == s,select="species")
        } else {
          Tot_A <- subset(Tot_A,class == s,select="species")
        }
        Species_accum_OBSTOT <- Species_accum_OBSTOT+nrow(Tot_A) # accumulated observation number each years
        Species_accum_Taxa$obs[i] <- Species_accum_OBSTOT 
        Tot_A <- Tot_A %>% unique %>% as.data.frame
        # The next line extract the species present at n, not present at n-1
        Species_accum_TEMP <- anti_join(Tot_A,Species_accum_LISTE,id = "species")
        # Then merge the species at n with those present in the previous years
        Species_accum_LISTE <- rbind(Species_accum_LISTE,Species_accum_TEMP)
        # Then extract the number of accumulated species
        Species_accum_Taxa$sp[i] <- nrow(Species_accum_LISTE)
        # Every year divide the total number of species obs (accum) by the total nbr obs
        Species_accum_Taxa$sp.obs[i] <- nrow(Species_accum_LISTE)/Species_accum_OBSTOT
        
        Species_accum_Taxa$Taxa <- s
      }
      ;Species_accum_Taxa})
    Species_accum <- as.data.frame(do.call(rbind,Tot_A))
    Species_accum$Distance <- x
    ;Species_accum}
    ,mc.cores = 3)
  Sp.Curve <- as.data.frame(do.call(rbind,Sp.Curve))
  Sp.Curve$city <- names(lSp.Curve)[i]
  lSp.Curve[[i]] <- Sp.Curve
}
dfSp.Curve <- do.call(rbind,lSp.Curve)
dfSp.Curve$sp <- as.numeric(dfSp.Curve$sp)
dfSp.Curve$Year <- as.numeric(dfSp.Curve$Year)
saveRDS(dfSp.Curve,file = "Species_Curve_Data_YEAR_1000_50000.rds")
```

Here load the Yearly data and the city data
```{r}
list.files()
Myrds <- as.list(list.files()[c(8,19)])
rds_ALL <- lapply(Myrds,function(x) readRDS(x))
dfSp.Curve <- rds_ALL[[2]]
dfcity <- rds_ALL[[1]]
```

Make the cities data to match with the buffer data (so wa have to repeat the vector over the different buffer size). 
```{r}
dist <- unique(dfSp.Curve$Distance)
dfcity <-merge(dist,dfcity)
dfcity$Distance <- dfcity$x
dfcity$sp.obs <- as.numeric(dfcity$sp.obs)
```

Here we choose whether we want to represent the unique species number over time ("sp") or if we want to weight by the sampling effort = "sp.obs"
```{r}
N <- 2
Resp <- c("sp","sp.obs")
LAB <- c("Number of species","Number of species / number observation")
```


Here plot the results as species accumulation plot. 
First: One facet with all information
```{r}
p1<-ggplot(dfSp.Curve,
           aes(x=Year,
               y=get(Resp[N]),
               color=as.factor(Taxa),
               group=as.factor(Taxa)))+
  geom_line(size=1)+
  geom_point(size=1,stroke=1)+
  #facet_wrap(city ~ Distance,scales = "free")+
  facet_grid(city ~ Distance,scales = "free",margins = F)+
  geom_hline(data=dfcity,
             aes(yintercept=get(Resp[N]),
                 color=as.factor(Taxa),
                 group=as.factor(Taxa),
               linetype="Administrative boundaries"), 
             size=0.5) +
  scale_linetype_manual(name = "Administrative boundaries",
                        values = c("dashed"))+
  labs(y=LAB[N],
       x="Year")+
  theme_light(base_size = 15)+
  theme(text = element_text(face="bold"),
        #legend.position = c(.65, .99),
        legend.position = c("bottom"),
        #legend.justification = c("left", "top"),
        legend.justification = c("center"),
        legend.direction ="horizontal",
        axis.text.x = element_text(size=13,color="black",angle = 60,vjust = 0.5),
        axis.text.y = element_text(size=13,color="black"),
        legend.text=element_text(size=12),
        legend.key.size = unit(1.5,"line"),
        legend.key.width = unit(2,"line"),
        legend.margin = margin(1,1,1,1),
        legend.box.margin = margin(1,1,1,1),
        legend.title = element_blank(),
        legend.background=element_rect(fill="white",
                                       colour="black",
                                       size=0.2),
        panel.border = element_rect(colour = "black",
                                    fill=NA,
                                    size=0.8),
        axis.line = element_line(colour="black"),
        plot.title = element_text(size=18,hjust = 0.5),
        plot.caption = element_text(face="bold.italic"))
print(p1)
save_plot(filename = paste0("Species_Curve_Accum_Year_1000_50000_AllTaxa_",Resp[N],".pdf"),
          plot = p1,
          base_width = 15,
          base_height = 12,
          dpi = 1000,
          units = "in",1)
#saveRDS(p1,file = "Species_Curve_Accum_1000_50000.rds")
```

Second: One curve by city with taxa and buffer as facet
```{r}
for (i in unique(dfSp.Curve$city)){
dfSp.Curve_city <- dfSp.Curve[dfSp.Curve$city==i,]
dfcity_city <- dfcity[dfcity$city==i,]
p1<-ggplot(dfSp.Curve_city,
           aes(x=Year,
               y=get(Resp[N]),
               color=as.factor(Taxa),
               group=as.factor(Taxa)))+
  geom_line(size=0.5)+
  geom_point(size=1.5,stroke=0.5,shape=22)+
  #facet_wrap(city ~ Distance,scales = "free")+
  facet_grid(Taxa ~ Distance,scales = "free",margins = F)+
  geom_hline(data=dfcity_city,
             aes(yintercept=get(Resp[N]),
                 color=as.factor(Taxa),
                 group=as.factor(Taxa),
               linetype="Administrative boundaries"), 
             size=0.5) +
  scale_linetype_manual(name = "Administrative boundaries",
                        values = c("dashed"))+
  ggtitle(paste0("City of ",i))+
  labs(y=LAB[N],
       x="Year")+
  theme_light(base_size = 15)+
  theme(text = element_text(face="bold"),
        #legend.position = c(.65, .99),
        legend.position = c("bottom"),
        #legend.justification = c("left", "top"),
        legend.justification = c("center"),
        legend.direction ="horizontal",
        axis.text.x = element_text(size=13,color="black",angle = 60,vjust = 0.5),
        axis.text.y = element_text(size=13,color="black"),
        legend.text=element_text(size=12),
        legend.key.size = unit(1.5,"line"),
        legend.key.width = unit(2,"line"),
        legend.margin = margin(1,1,1,1),
        legend.box.margin = margin(1,1,1,1),
        legend.title = element_blank(),
        legend.background=element_rect(fill="white",
                                       colour="black",
                                       size=0.2),
        panel.border = element_rect(colour = "black",
                                    fill=NA,
                                    size=0.8),
        axis.line = element_line(colour="black"),
        plot.title = element_text(size=18,hjust = 0.5),
        plot.caption = element_text(face="bold.italic"))
print(p1)
save_plot(filename = paste0("Species_Curve_Accum_Year_1000_50000_",Resp[N],"_",i,".pdf"),
          plot = p1,
          base_width = 15,
          base_height = 12,
          dpi = 1000,
          units = "in",1)
}
```



Filter the data first by animal or plant 
And then keep look at the repartition according to the order (mamalia, aves etc...)
Obtain the number of SPECIES by taxa
First we load the 4 database for each city 
Then we extract by city the proportion of Animalia or plants 

Here we want to keep the total number of species, total number of animal,
total number of plants, 
total number of birds 
total spider
total insects 
```{r}

```


```{r}



dfM_A <- dfM %>% 
  filter(kingdom == "Animalia")
dfM_A <- dfM_A |>
  group_by(class) |>
  summarise(speciesrichness = length(unique(species))) %>% 
              arrange(desc(speciesrichness))
dfM_A$speciesprop <- dfM_A$speciesrichness/sum(dfM_A$speciesrichness)*100
dfM_A$city <- "Munich"

dfM_P <- gbif_download %>% 
  filter(kingdom == "Plantae")
dfM_P <- dfM_P |>
  group_by(class) |>
  summarise(speciesrichness = length(unique(species))) %>% 
              arrange(desc(speciesrichness))
dfM_P$speciesprop <- dfM_P$speciesrichness/sum(dfM_P$speciesrichness)*100
dfM_P$city <- "Munich"

dfTA_A <- dfTA %>% 
  filter(kingdom == "Animalia")
dfTA_A <- dfTA_A |>
  group_by(class) |>
  summarise(speciesrichness = length(unique(species))) %>% 
              arrange(desc(speciesrichness))
dfTA_A$speciesprop <- dfTA_A$speciesrichness/sum(dfTA_A$speciesrichness)*100
dfTA_A$city <- "Tel Aviv"

dfTA_P <- gbif_download %>% 
  filter(kingdom == "Plantae")
dfTA_P <- dfTA_P |>
  group_by(class) |>
  summarise(speciesrichness = length(unique(species))) %>% 
              arrange(desc(speciesrichness))
dfTA_P$speciesprop <- dfTA_P$speciesrichness/sum(dfTA_P$speciesrichness)*100
dfTA_A$city <- "Tel Aviv"

dfG_A <- dfG %>% 
  filter(kingdom == "Animalia")
dfG_A <- dfG_A |>
  group_by(class) |>
  summarise(speciesrichness = length(unique(species))) %>% 
              arrange(desc(speciesrichness))
dfG_A$speciesprop <- dfG_A$speciesrichness/sum(dfG_A$speciesrichness)*100

dfG_P <- gbif_download %>% 
  filter(kingdom == "Plantae")
dfG_P <- dfG_P |>
  group_by(class) |>
  summarise(speciesrichness = length(unique(species))) %>% 
              arrange(desc(speciesrichness))
dfG_P$speciesprop <- dfG_P$speciesrichness/sum(dfG_P$speciesrichness)*100

dfW_A <- dfW %>% 
  filter(kingdom == "Animalia")
dfW_A <- dfW_A |>
  group_by(class) |>
  summarise(speciesrichness = length(unique(species))) %>% 
              arrange(desc(speciesrichness))
dfW_A$speciesprop <- dfW_A$speciesrichness/sum(dfW_A$speciesrichness)*100

dfW_P <- gbif_download %>% 
  filter(kingdom == "Plantae")
dfW_P <- dfW_P |>
  group_by(class) |>
  summarise(speciesrichness = length(unique(species))) %>% 
              arrange(desc(speciesrichness))
dfW_P$speciesprop <- dfW_P$speciesrichness/sum(dfW_P$speciesrichness)*100
```





Pick the city we want to work with: 
```{r}
gbif_download <- dfG
City <- "Genova"
```

Filter by location (distance to zoo, ocean removal etc...)
Apply further filters
```{r}
gbif_download <- gbif_download %>%
setNames(tolower(names(.))) %>% # set lowercase column names to work with CoordinateCleaner
filter(occurrencestatus  == "PRESENT") %>%
filter(!is.na(decimallongitude)) %>% 
filter(!is.na(decimallatitude)) %>% 
filter(!basisofrecord %in% c("FOSSIL_SPECIMEN","LIVING_SPECIMEN")) %>%
filter(coordinateprecision < 0.01 | is.na(coordinateprecision)) %>% 
filter(coordinateuncertaintyinmeters < 10000 | is.na(coordinateuncertaintyinmeters)) %>%
filter(!coordinateuncertaintyinmeters %in% c(301,3036,999,9999)) %>% 
filter(!decimallatitude == 0 | !decimallongitude == 0) %>%
#cc_cap(buffer = 2000) %>% # remove capitals centroids within 2km
cc_inst(buffer = 200) %>% # remove zoo and herbaria within 2km 
cc_sea() %>% # remove from ocean 
distinct(decimallongitude,decimallatitude,specieskey,datasetkey, .keep_all = TRUE) %>%
glimpse() # look at results of pipeline
```


Then we can plot the results (barplot). To modify
```{r}
barplot(R1_P$speciesprop)
```


## Now we want to extrat the center and plot within a radius around it. 
Here map of the results
```{r}
n <- 0.1
cols <- c("red4","#F4A582","white","#92C5DE","darkblue")
cols <- rev(cols)
pm <- qmplot(decimallongitude, decimallatitude, data = gbif_download,size = I(1),zoom = 11,maptype = "toner",extent = "normal",f=2.5,xlim = c(min(gbif_download$decimallongitude-n),max(gbif_download$decimallongitude+n)), ylim = c(min(gbif_download$decimallatitude-n),max(gbif_download$decimallatitude+n))) + 
  theme(panel.background = element_rect(fill="white", colour="black", size=4, 
    linetype=1, color="black"),legend.key.size = unit(3, "cm"),legend.position=c(0.5,0.5)) +
    theme(panel.grid.major = element_line(colour="blue", size=4, linetype=0,lineend="square", color="red"),
          panel.grid.minor = element_line(colour="blue", size=1, linetype=0,lineend="round", color="blue"))+
    theme(legend.background = element_rect(fill="white",size=1, linetype="solid", 
                                           colour ="black"))+
    geom_point(data = gbif_download, aes(x = decimallongitude,
                                         y = decimallatitude,
                                         col=factor(kingdom)),
               shape=21,
               size=0.01)+
  scale_colour_manual(name="Kingdom", values = c("Plantae"="green","Animalia"="blue"))+
    labs(title=paste0("Munich species occurrence"), y=paste0("Latitude"), x="Longitude")+
    theme(text = element_text(face="bold"),legend.direction ="vertical",
          legend.position = c("right"),
          legend.justification = c(0,1),
          axis.text.x = element_text(size=18,color="black"),axis.text.y = element_text(size=18,color="black"),
          axis.title.x = element_text(size=18),axis.title.y = element_text(size=18),
          legend.key = element_rect(fill = "white", colour = "black",size = 1),
          legend.background=element_rect(fill="white",colour="black",size=0),
          legend.key.heigh = unit(2,"line"),
          legend.key.width = unit(1,"line"),
          legend.key.size = unit(5,"line"),
          legend.text=element_text(size=14),
          legend.title=element_text(size=15),
          panel.border = element_rect(colour = "black", fill=NA, size=0),
          axis.line = element_line(colour="black"),
          plot.margin = margin(0,0,0,0, "cm"),
          plot.title = element_text(size=12,hjust = 0.02,vjust = -1),
          plot.caption = element_text(face="bold.italic"))
print(pm)
save_plot(filename = paste0("~/Mon Drive/Postdoc_Italy/data/GBIF/",City,"_map.pdf"),
          plot = pm,base_width = 12, base_height = 7, dpi = 400 ,units = "in",1)
```










